# Цель работы
Целью данной лабораторной работы является изучение принципов разработки RESTful API с использованием фреймворка FastAPI, автоматической генерации документации OpenAPI и тестирования API с помощью Swagger UI.

# Задачи
1. Установить и настроить окружение для разработки с FastAPI.
2. Создать простое REST API для управления ресурсами (например, список задач или книг).
3. Реализовать основные операции CRUD (Create, Read, Update, Delete).
4. Добавить валидацию данных с использованием Pydantic моделей.
5. Изучить автоматически сгенерированную документацию OpenAPI.
6. Протестировать API с помощью Swagger UI.
7. Добавить обработку ошибок и соответствующие коды состояния HTTP.


### Документирование эндпоинтов

Каждый эндпоинт документируется с помощью docstring (тройных кавычек):

```python
@app.get("/api/books", response_model=List[Book], tags=["Books"])
async def get_books(...):
    """
    Получить список книг с пагинацией и фильтрацией.
    - **skip**: Количество книг для пропуска (offset)
    - **limit**: Максимальное количество книг в ответе
    - **author**: Фильтр по автору (частичное совпадение)
    - **year_from**: Минимальный год издания
    - **year_to**: Максимальный год издания
    """
```

### Документирование моделей данных

Pydantic модели используют `Field` для описания полей:

```python
class Book(BaseModel):
    title: str = Field(..., min_length=1, max_length=200, description="Название книги")
    author: str = Field(..., min_length=1, max_length=100, description="Автор книги")
    year: int = Field(..., ge=1000, le=datetime.now().year, description="Год издания")
```

### Теги для группировки эндпоинтов

Эндпоинты группируются с помощью параметра `tags`:
- `tags=["Books"]` - эндпоинты для работы с книгами
- `tags=["Statistics"]` - эндпоинты статистики
- `tags=["Root"]` - корневой эндпоинт

## Список эндпоинтов API

### Корневой эндпоинт

#### `GET /`
- **Описание**: Корневой эндпоинт API
- **Аутентификация**: Не требуется
- **Ответ**: Приветственное сообщение и ссылки на документацию

### Эндпоинты для работы с книгами

#### `GET /api/books`
- **Описание**: Получить список книг с пагинацией и фильтрацией
- **Аутентификация**: Не требуется
- **Параметры запроса**:
  - `skip` (int, по умолчанию: 0) - количество книг для пропуска
  - `limit` (int, по умолчанию: 10) - максимальное количество книг в ответе
  - `author` (str, опционально) - фильтр по автору (частичное совпадение)
  - `year_from` (int, опционально) - минимальный год издания
  - `year_to` (int, опционально) - максимальный год издания
- **Ответ**: Список книг (массив объектов Book)

#### `GET /api/books/{book_id}`
- **Описание**: Получить книгу по ID
- **Аутентификация**: Не требуется
- **Параметры пути**:
  - `book_id` (int) - ID книги
- **Ответ**: Объект Book
- **Ошибки**: 404 - если книга не найдена

#### `POST /api/books`
- **Описание**: Создать новую книгу в базе данных
- **Аутентификация**: **Требуется** (API ключ в заголовке `X-API-Key`)
- **Тело запроса**: Объект Book (без поля id)
- **Ответ**: Созданная книга с присвоенным ID (код 201)
- **Пример тела запроса**:
  ```json
  {
    "title": "Мастер и Маргарита",
    "author": "Михаил Булгаков",
    "year": 1967,
    "isbn": "9785170123456"
  }
  ```

#### `PUT /api/books/{book_id}`
- **Описание**: Полностью обновить информацию о книге
- **Аутентификация**: **Требуется** (API ключ в заголовке `X-API-Key`)
- **Параметры пути**:
  - `book_id` (int) - ID книги для обновления
- **Тело запроса**: Объект Book со всеми полями (без id)
- **Ответ**: Обновленная книга
- **Ошибки**: 404 - если книга не найдена

#### `PATCH /api/books/{book_id}`
- **Описание**: Частично обновить информацию о книге
- **Аутентификация**: **Требуется** (API ключ в заголовке `X-API-Key`)
- **Параметры пути**:
  - `book_id` (int) - ID книги для обновления
- **Тело запроса**: Объект BookUpdate (все поля опциональны)
- **Ответ**: Обновленная книга
- **Ошибки**: 404 - если книга не найдена

#### `DELETE /api/books/{book_id}`
- **Описание**: Удалить книгу по ID
- **Аутентификация**: **Требуется** (API ключ в заголовке `X-API-Key`)
- **Параметры пути**:
  - `book_id` (int) - ID книги для удаления
- **Ответ**: Пустое тело (код 204)
- **Ошибки**: 404 - если книга не найдена

### Эндпоинты статистики

#### `GET /api/books/stats`
- **Описание**: Получить статистику по книгам
- **Аутентификация**: Не требуется
- **Ответ**: Объект со статистикой:
  ```json
  {
    "total_books": 10,
    "books_by_author": {
      "Лев Толстой": 3,
      "Федор Достоевский": 2
    },
    "books_by_century": {
      "19 век": 8,
      "20 век": 2
    }
  }
  ```


### Защищенные эндпоинты

Следующие эндпоинты требуют аутентификации:
- `POST /api/books` - создание книги
- `PUT /api/books/{book_id}` - полное обновление книги
- `PATCH /api/books/{book_id}` - частичное обновление книги
- `DELETE /api/books/{book_id}` - удаление книги

### Открытые эндпоинты

Следующие эндпоинты доступны без аутентификации:
- `GET /` - корневой эндпоинт
- `GET /api/books` - список книг
- `GET /api/books/{book_id}` - книга по ID
- `GET /api/books/stats` - статистика

### Ошибки аутентификации

При неверном или отсутствующем API ключе возвращается ошибка:
- **Код**: 403 Forbidden
- **Ответ**:
  ```json
  {
    "detail": "Неверный API ключ"
  }
  ```

## Модель данных Book

```python
{
  "id": 1,
  "title": "Война и мир",
  "author": "Лев Толстой",
  "year": 1869,
  "isbn": "9785170987654"
}
```

## Пример использования
### Создать новую книгу
```bash
curl -X POST "http://localhost:8000/api/books" \
  -H "X-API-Key: secret-api-key-12345" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Преступление и наказание",
    "author": "Федор Достоевский",
    "year": 1866,
    "isbn": "9785170876543"
  }'
```

### Получить статистику
```bash
curl http://localhost:8000/api/books/stats
```

## Выводы

В ходе выполнения лабораторной работы были изучены основные принципы разработки RESTful API с использованием FastAPI. Освоены технологии **FastAPI**, **Pydantic**, **SQLAlchemy** и **OpenAPI/Swagger** для создания веб-приложений.

Приобретены навыки разработки REST API с реализацией операций CRUD, работы с базами данных через ORM, добавления фильтрации и пагинации, реализации аутентификации с API ключами, валидации данных и обработки ошибок, а также автоматической генерации документации.

Создано полнофункциональное REST API приложение для управления библиотекой книг с интеграцией SQLite базы данных, системой аутентификации и автоматической документацией OpenAPI.