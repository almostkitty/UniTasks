# Лабораторная работа #2 - WSGI и ASGI

## Пальчук Герман, ИВТ 2.1

### Цель работы:
- Научиться разрабатывать микросервисы с использованием Flask и WSGI.
- Применить многопроцессность для повышения производительности сервисов.
- Научиться упаковывать приложения в Docker-контейнеры.
- Освоить развёртывание serverless-приложений в Yandex Cloud.

## Задание 1
1. Выберите один из предложенных вариантов набора микросервисов.
2. Разработайте набор микросервисов на основе выбранного варианта с
использованием Flask и WSGI. Все сервисы должны взаимодействовать в
формате JSON.
3. Реализуйте многопроцессность для повышения эффективности работы
сервисов.
4. Упакуйте приложение в Docker-контейнер.
5. Разверните приложение в Yandex Cloud как серверless-приложение.

### Вариант 3: Новостной агрегатор
- Сервис парсинга новостей: Собирает новости из различных открытых RSS-лент.
- Сервис анализа тональности (можно просто по словам): Определяет эмоциональную окраску новостей (позитивная, негативная, нейтральная) с помощью простого алгоритма или библиотеки.
- Сервис категоризации: Распределяет новости по категориям (спорт, политика, технологии и т.д.). Можно заранее задать какие новостные ленты имеют какую тематику.
- Дополнительно: Реализуйте многопроцессность для одновременной обработки новостей из разных источников.

### Требования к реализации
- Использование Flask (WSGI): Все микросервисы должны быть разработаны с использованием Flask и соответствовать спецификации WSGI.
- Формат данных: Взаимодействие между сервисами и с клиентом должно происходить в формате JSON.
- Многопроцессность: Примените модуль multiprocessing для реализации многопроцессности в вашем приложении.

### Упаковка в Docker-контейнер
1. Создайте Dockerfile, в котором опишите все зависимости и инструкции для сборки вашего приложения.
2. Соберите Docker-образ с вашим приложением.
3. Протестируйте контейнер локально, убедившись, что все сервисы работают корректно.

## Реализация

### Архитектура проекта
Реализован новостной агрегатор, состоящий из трёх микросервисов:

1. **News Parser** (`services/news_parser/`) - сервис парсинга новостей из RSS-лент
2. **Sentiment Analyzer** (`services/sentiment_analyzer/`) - сервис анализа тональности новостей
3. **Categorizer** (`services/categorizer/`) - сервис категоризации новостей

Все сервисы взаимодействуют в формате JSON через HTTP API.

### Технологический стек
- **Python 3.13** - язык программирования
- **Flask 3.0.0** - веб-фреймворк (WSGI)
- **Gunicorn 21.2.0** - WSGI HTTP сервер для production
- **feedparser** - библиотека для парсинга RSS-лент (установлена из git-репозитория для совместимости с Python 3.13)
- **ThreadPoolExecutor** - для параллельной обработки (threading вместо multiprocessing для совместимости с serverless)
- **Docker** - контейнеризация приложений
- **Yandex Cloud Serverless Containers** - платформа развертывания

### Реализация многопроцессности
Изначально использовался модуль `multiprocessing` для параллельной обработки:
- Парсинг нескольких RSS-лент одновременно
- Параллельный анализ тональности новостей
- Параллельная категоризация новостей

**Важное изменение:** В процессе развертывания в Yandex Cloud Serverless Containers выяснилось, что `multiprocessing.Pool` не работает в serverless окружении из-за ограничений на создание процессов. Модуль `multiprocessing` пытается создать семафоры и блокировки через системные вызовы, которые недоступны в serverless контейнерах.

**Решение:** Заменён `multiprocessing.Pool` на `ThreadPoolExecutor` из модуля `concurrent.futures`. Threading работает корректно в serverless окружениях, так как использует потоки вместо процессов.

### Docker-контейнеризация
Для каждого сервиса создан отдельный Dockerfile:
- `services/news_parser/Dockerfile`
- `services/sentiment_analyzer/Dockerfile`
- `services/categorizer/Dockerfile`

### Развертывание в Yandex Cloud

#### Подготовка
1. Создан Container Registry: `news-aggregator-registry`
2. Создан Service Account: `news-aggregator-sa` с правами на чтение образов из реестра
3. Настроен Docker для работы с Yandex Container Registry

#### Проблемы и решения при развертывании

**Проблема 1: Multiprocessing в serverless**
- **Ошибка:** `Internal Server Error` с traceback в `multiprocessing.synchronize.SemLock`
- **Причина:** `multiprocessing.Pool` не может создать процессы и семафоры в serverless окружении
- **Решение:** Заменён `multiprocessing.Pool` на `ThreadPoolExecutor` во всех трёх сервисах

## API эндпоинты

### News Parser
- `GET /` - информация о сервисе
- `GET /health` - проверка здоровья сервиса
- `POST /parse` - парсинг новостей из RSS-лент
  ```json
  {
    "feeds": ["https://lenta.ru/rss", "https://ria.ru/export/rss2/index.xml"]
  }
  ```

### Sentiment Analyzer
- `GET /` - информация о сервисе
- `GET /health` - проверка здоровья сервиса
- `POST /analyze` - анализ тональности новостей
  ```json
  {
    "news": [
      {
        "title": "Заголовок новости",
        "description": "Описание новости"
      }
    ]
  }
  ```

### Categorizer
- `GET /` - информация о сервисе
- `GET /health` - проверка здоровья сервиса
- `POST /categorize` - категоризация новостей
  ```json
  {
    "news": [
      {
        "title": "Заголовок новости",
        "description": "Описание новости"
      }
    ]
  }
  ```

## Результаты

Все три сервиса успешно развернуты в Yandex Cloud Serverless Containers и работают корректно:
- Парсинг RSS-лент работает
- Анализ тональности работает
- Категоризация новостей работает
- Параллельная обработка через threading функционирует в serverless окружении

## Выводы

1. **WSGI и Flask:** Flask отлично подходит для создания микросервисов с WSGI-интерфейсом. Gunicorn обеспечивает стабильную работу в production.

2. **Многопроцессность vs Многопоточность:** В serverless окружениях `multiprocessing` не работает из-за ограничений на создание процессов. `ThreadPoolExecutor` является рабочей альтернативой для параллельной обработки.

3. **Docker и архитектура:** При разработке на Mac с ARM-процессором необходимо явно указывать платформу `linux/amd64` при сборке образов для облачных платформ.

4. **Serverless контейнеры:** Yandex Cloud Serverless Containers имеют специфические требования (порт 8080, ограничения на процессы), которые необходимо учитывать при разработке.


## Скриншоты

1. Локальное тестирование сервисов
![](/img/img1)
![](/img/img2)
![](/img/img3)
![](/img/img4)

2. Docker образы
![](/img/img5)

3. Yandex Cloud
![](/img/img6)

4. Работающие сервисы
![](/img/img7)

5. Логи из Yandex Cloud
![](/img/img8)
